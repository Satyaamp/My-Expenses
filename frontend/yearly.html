<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dhanâ‚¹ekha â€“ Yearly Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#22c55e">

  <link rel="shortcut icon" href="assets/icons/dashboard.png" type="image/png">
  <link rel="stylesheet" href="css/glass.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <style>
    .year-navigation {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      padding: 15px;
      position: sticky;
      top: 10px;
      z-index: 10;
    }
    .nav-arrow {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .nav-arrow:active {
      transform: scale(0.95);
    }
    #currentYearDisplay { font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    #yearInput { background: transparent; border: none; border-bottom: 2px solid white; color: white; font-size: 1.5rem; font-weight: bold; width: 80px; text-align: center; outline: none; display: none; }

    .chart-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    @media (min-width: 768px) {
      .chart-grid {
        grid-template-columns: 2fr 1fr;
      }
    }
    @media (max-width: 768px) {
      .btn-text { display: none; }
      #downloadYearlyBtn { padding: 8px !important; }
    }
    @media (max-width: 768px) {
      /* Force show 4th column (Savings) for monthly breakdown table */
      .monthly-breakdown th:nth-child(4),
      .monthly-breakdown td:nth-child(4) {
        display: table-cell !important;
      }
    }
  </style>
</head>
<body>

  <!-- Auth Guard -->
  <script src="js/authGuard.js"></script>

  <!-- Navbar -->
  <nav class="navbar glass-card">
    <div class="logo" onclick="location.href='dashboard.html'" style="cursor: pointer;">
        <img src="assets/logo1.png" alt="Dhanâ‚¹ekha Logo" />
        <span>Dhanâ‚¹ekha</span>
    </div>

    <div class="nav-actions">
    <button onclick="location.href='monthly.html'" class="nav-btn-profile">
      <span class="desktop-text">ðŸ“… Monthly</span>
      <span class="mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></span>
    </button>
    <button onclick="location.href='dashboard.html'" class="nav-btn" title="Dashboard">
      <span class="desktop-text">Dashboard</span>
      <span class="mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span>
    </button>
    </div>
  </nav>

  <main class="container">
    
    <!-- Year Navigation -->
    <div class="year-navigation glass-card">
      <button id="prevYearBtn" class="nav-arrow">&lt;</button>
      <span id="currentYearDisplay"></span>
      <input type="number" id="yearInput" />
      <button id="nextYearBtn" class="nav-arrow">&gt;</button>
    </div>

    <!-- Summary Cards -->
    <section class="summary">
      <div class="summary-card glass-card">
        <div class="liquid-bg liquid-green" style="height: 100%; opacity: 0.1;"></div>
        <div class="card-content">
          <h4>Net Savings</h4>
          <p id="yearlyBalance">â‚¹0</p>
        </div>
      </div>
      <div class="summary-card glass-card">
        <div class="liquid-bg liquid-blue" style="height: 100%; opacity: 0.1;"></div>
        <div class="card-content">
          <h4>Total</h4>
          <p id="yearlyIncome">â‚¹0</p>
        </div>
      </div>
      <div class="summary-card glass-card">
        <div class="liquid-bg liquid-red" style="height: 100%; opacity: 0.1;"></div>
        <div class="card-content">
          <h4>Total Expense</h4>
          <p id="yearlyExpense">â‚¹0</p>
        </div>
      </div>
    </section>

    <!-- Monthly Wise Summary Table -->
    <section id="monthlyBreakdownSection" class="glass-card" style="margin-top: 20px; padding: 20px;">
      <h3 style="margin-bottom: 15px;">Monthly Breakdown</h3>
      <div class="table-responsive" style="overflow-x: auto;">
        <table class="expense-table monthly-breakdown" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Month</th>
              <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Income</th>
              <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Expense</th>
              <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Savings</th>
            </tr>
          </thead>
          <tbody id="monthlyTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Charts -->
    <div class="chart-grid">
      <section class="glass-card" style="padding: 20px;">
        <h3>Monthly Breakdown</h3>
        <div class="chart-wrapper">
          <canvas id="monthlyBreakdownChart"></canvas>
        </div>
      </section>

      <section class="glass-card" style="padding: 20px;">
        <h3>Category Distribution</h3>
        <div class="chart-wrapper">
          <canvas id="categoryDistributionChart"></canvas>
        </div>
      </section>
    </div>

    <!-- All Expenses Table for Selected Year -->
    <section id="allExpensesSection" class="glass-card" style="margin-top: 20px; padding: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">All Expenses (<span id="tableYearDisplay"></span>)</h3>
        <button id="downloadYearlyBtn" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; transition: background 0.2s;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          <span class="btn-text">Download Report</span>
        </button>
      </div>
      <div style="margin-bottom: 15px; display: flex; justify-content: flex-end;">
        <input type="text" id="expenseSearch" placeholder="Search by date (e.g. 12 Oct)..." style="width: 250px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; outline: none;">
      </div>
      <div class="table-responsive" style="overflow-x: auto;">
        <table class="expense-table" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Date</th>
              <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Amount</th>
              <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Category</th>
              <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Description</th>
            </tr>
          </thead>
          <tbody id="yearlyExpenseTableBody"></tbody>
        </table>
      </div>
      <div class="pagination-controls" style="text-align: center; margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 15px;">
        <button id="prevPageBtn" style="padding: 8px 12px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; color: white; cursor: pointer; transition: all 0.2s;">Previous</button>
        <span id="pageInfo" style="font-weight: 600; color: rgba(255,255,255,0.8);"></span>
        <button id="nextPageBtn" style="padding: 8px 12px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; color: white; cursor: pointer; transition: all 0.2s;">Next</button>
      </div>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script type="module" src="js/yearly.js"></script>
  <script type="module">
    import { apiRequest, showToast } from './js/api.js';

    const tableBody = document.getElementById('yearlyExpenseTableBody');
    const tableYearDisplay = document.getElementById('tableYearDisplay');
    const currentYearDisplay = document.getElementById('currentYearDisplay');
    
    let currentYearExpenses = [];
    let filteredExpenses = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    async function loadYearlyExpenses(year) {
      if (!year) return;
      tableYearDisplay.innerText = year;
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">Loading...</td></tr>';

      try {
        const res = await apiRequest('/expenses', 'GET', null, { skipLoader: true });
        currentYearExpenses = (res.data || []).filter(tx => {
          return new Date(tx.date).getFullYear() === parseInt(year);
        }).sort((a, b) => new Date(b.date) - new Date(a.date));

        filteredExpenses = [...currentYearExpenses];
        currentPage = 1;
        renderTablePage();
      } catch (e) {
        console.error(e);
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #ef4444;">Failed to load data.</td></tr>';
      }
    }

    function renderTablePage() {
        const totalPages = Math.ceil(filteredExpenses.length / itemsPerPage);
        
        if (filteredExpenses.length === 0) {
          if (currentYearExpenses.length > 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; opacity: 0.7;">No transactions at this date.</td></tr>';
          } else {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; opacity: 0.7;">No expenses found for this year.</td></tr>';
          }
          updatePaginationUI(0);
          return;
        }

        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageData = filteredExpenses.slice(start, end);

        tableBody.innerHTML = pageData.map(tx => `
          <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
            <td style="padding: 12px; white-space: nowrap;">${new Date(tx.date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
            <td style="padding: 12px; font-weight: 600; color: #ef4444;">â‚¹${tx.amount}</td>
            <td style="padding: 12px;"><span style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem;">${tx.category}</span></td>
            <td style="padding: 12px; opacity: 0.8;">${tx.description || '-'}</td>
          </tr>
        `).join('');
        
        updatePaginationUI(totalPages);
    }

    function updatePaginationUI(totalPages) {
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const info = document.getElementById('pageInfo');
        
        if(info) info.innerText = totalPages > 0 ? `Page ${currentPage} of ${totalPages}` : '';
        
        if(prevBtn) {
            prevBtn.disabled = currentPage <= 1;
            prevBtn.style.opacity = prevBtn.disabled ? 0.5 : 1;
            prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
        }
        if(nextBtn) {
            nextBtn.disabled = currentPage >= totalPages;
            nextBtn.style.opacity = nextBtn.disabled ? 0.5 : 1;
            nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
        }
    }

    document.getElementById('prevPageBtn')?.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderTablePage();
        }
    });

    document.getElementById('nextPageBtn')?.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredExpenses.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTablePage();
        }
    });

    const observer = new MutationObserver(() => {
      const year = currentYearDisplay.innerText;
      if (year) loadYearlyExpenses(year);
    });

    if (currentYearDisplay) {
      observer.observe(currentYearDisplay, { childList: true, characterData: true, subtree: true });
    }

    document.getElementById('expenseSearch')?.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase().trim();
      filteredExpenses = currentYearExpenses.filter(tx => {
        const d = new Date(tx.date);
        // Use numeric day (e.g., "1 Oct") to allow exact matching of day numbers
        const day = d.getDate();
        const month = d.toLocaleString('en-IN', { month: 'short' });
        const year = d.getFullYear();
        const dateStr = `${day} ${month} ${year}`.toLowerCase();
        
        // Use word boundary (\b) to ensure "1 oct" doesn't match "11 oct"
        const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return new RegExp(`\\b${safeTerm}`, 'i').test(dateStr);
      });
      currentPage = 1;
      renderTablePage();
    });

    async function toDataURL(url) {
      const response = await fetch(url);
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // PDF Download Logic
    document.getElementById('downloadYearlyBtn')?.addEventListener('click', async () => {
      if (!currentYearExpenses || currentYearExpenses.length === 0) {
        showToast("No data to download for this year", "error");
        return;
      }

      showToast("Generating PDF...", "success");
      
      let userName = "User";
      try {
        const userRes = await apiRequest('/auth/me', 'GET', null, { skipLoader: true });
        if (userRes.data && userRes.data.name) {
          userName = userRes.data.name;
        }
      } catch (e) { console.warn("Could not fetch user name", e); }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const year = tableYearDisplay.innerText;

      // Header
      doc.setFillColor(15, 32, 39);
      doc.rect(0, 0, 210, 40, "F");

      try {
        const logo = await toDataURL('assets/logo1.png');
        doc.addImage(logo, 'PNG', 14, 8, 24, 24);
      } catch (e) { console.warn("Logo not loaded", e); }

      doc.setFont("helvetica", "bold");
      doc.setFontSize(22);
      doc.setTextColor(34, 197, 94);
      doc.text("DhanRekha", 44, 20);
      doc.setFontSize(12);
      doc.setTextColor(255);
      doc.text(`Yearly Report - ${year}`, 44, 30);
      doc.text(`Prepared for: ${userName}`, 196, 25, { align: "right" });

      // Summary Section
      let income = document.getElementById('yearlyIncome')?.innerText || "0";
      let expense = document.getElementById('yearlyExpense')?.innerText || "0";
      let savings = document.getElementById('yearlyBalance')?.innerText || "0";

      // Replace â‚¹ symbol with Rs. for PDF font compatibility
      income = income.replace(/â‚¹/g, 'Rs. ');
      expense = expense.replace(/â‚¹/g, 'Rs. ');
      savings = savings.replace(/â‚¹/g, 'Rs. ');

      doc.setTextColor(0);
      doc.setFontSize(11);
      doc.text(`Total: ${income}`, 14, 50);
      doc.text(`Total Expense: ${expense}`, 80, 50);
      doc.text(`Net Savings: ${savings}`, 150, 50);

      // --- 1. Monthly Breakdown Table ---
      let finalY = 60;

      try {
        // Fetch income to calculate monthly breakdown
        const incRes = await apiRequest('/income', 'GET', null, { skipLoader: true });
        const yearIncomes = (incRes.data || []).filter(tx => new Date(tx.date).getFullYear() === parseInt(year));
        
        const monthlyData = new Array(12).fill(null).map(() => ({ inc: 0, exp: 0 }));
        
        yearIncomes.forEach(i => monthlyData[new Date(i.date).getMonth()].inc += i.amount);
        currentYearExpenses.forEach(e => monthlyData[new Date(e.date).getMonth()].exp += e.amount);

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthlyBody = [];

        monthlyData.forEach((d, i) => {
          if (d.inc > 0 || d.exp > 0) {
            monthlyBody.push([
              monthNames[i],
              `Rs. ${d.inc.toLocaleString('en-IN')}`,
              `Rs. ${d.exp.toLocaleString('en-IN')}`,
              `Rs. ${(d.inc - d.exp).toLocaleString('en-IN')}`
            ]);
          }
        });

        if (monthlyBody.length > 0) {
          doc.setFontSize(14);
          doc.setTextColor(34, 197, 94);
          doc.text("Monthly Breakdown", 14, finalY);
          
          doc.autoTable({
            startY: finalY + 5,
            head: [["Month", "Income", "Expense", "Savings"]],
            body: monthlyBody,
            theme: "grid",
            headStyles: { fillColor: [15, 32, 39], textColor: 255 },
            columnStyles: {
              1: { textColor: [34, 197, 94] }, // Green
              2: { textColor: [220, 38, 38] }, // Red
              3: { fontStyle: 'bold' }
            },
            didDrawPage: (data) => {
              const h = doc.internal.pageSize.getHeight();
              doc.setFontSize(8);
              doc.setTextColor(100);
              doc.text("DhanRekha â€¢ Where Your Money Tells a Story", 14, h - 10);
              doc.text(`${new Date().toLocaleString('en-IN')}`, 14, h - 6);
              doc.text(`Page ${data.pageNumber}`, 196, h - 10, { align: "right" });
            }
          });
          
          doc.addPage();
          finalY = 20;
        }
      } catch (e) {
        console.warn("Error generating monthly table for PDF", e);
      }

      // --- 2. Detailed Expenses Table ---
      doc.setFontSize(14);
      doc.setTextColor(34, 197, 94);
      doc.text("Expenses List", 14, finalY);

      const tableData = currentYearExpenses.map(tx => [
        new Date(tx.date).toLocaleDateString("en-IN"),
        `Rs. ${tx.amount}`,
        tx.category,
        tx.description || "-"
      ]);

      doc.autoTable({
        startY: finalY + 5,
        head: [["Date", "Amount", "Category", "Description"]],
        body: tableData,
        theme: "grid",
        headStyles: { fillColor: [20, 83, 45], textColor: 255 },
        columnStyles: {
          1: { halign: "right", fontStyle: "bold", textColor: [220, 38, 38] }
        },
        didDrawPage: (data) => {
          const h = doc.internal.pageSize.getHeight();
          doc.setFontSize(8);
          doc.setTextColor(100);
          doc.text("DhanRekha â€¢ Where Your Money Tells a Story", 14, h - 10);
          doc.text(`${new Date().toLocaleString('en-IN')}`, 14, h - 6);
          doc.text(`Page ${data.pageNumber}`, 196, h - 10, { align: "right" });
        }
      });

      doc.save(`DhanRekha_Yearly_Report_${year}.pdf`);
      showToast("Download complete!", "success");
    });
  </script>
</body>
</html>