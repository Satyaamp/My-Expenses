<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dhanâ‚¹ekha â€“ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#22c55e">

  <link rel="shortcut icon" href="assets/icons/dashboard.png" type="image/png">
  <link rel="stylesheet" href="css/glass.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <link rel="stylesheet" href="css/animations.css" />
  <style>
    .pagination-controls {
      text-align: center; 
      margin-top: 20px; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 15px;
    }
    .pagination-btn {
      width: auto; 
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .pagination-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.2);
    }
    .mobile-swipe-hint {
      display: none;
    }
    @media (max-width: 768px) {
      .mobile-swipe-hint { display: inline-block; font-size: 0.75rem; opacity: 0.6; font-weight: normal; margin-left: 8px; }
      .pagination-btn { display: none; }
    }
  </style>
</head>
<body>

  <!-- Auth Guard -->
  <script src="js/authGuard.js"></script>



  <!-- Navbar -->
  <nav class="navbar glass-card">
    <div class="logo">
        <img src="assets/logo1.png" alt="Dhanâ‚¹ekha Logo" />
        <span>Dhanâ‚¹ekha</span>
    </div>

    <!-- Desktop Date Range (Center) -->
    <div id="navbarDateRange" class="navbar-date-range"></div>

    <div class="nav-actions">
      <button onclick="location.href='monthly.html'" class="nav-btn-profile">
        <span class="desktop-text">ðŸ“… Monthly</span>
        <span class="mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></span>
      </button>
      <button onclick="location.href='yearly.html'" class="nav-btn-profile">
        <span class="desktop-text">ðŸ“Š Yearly</span>
        <span class="mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></span>
      </button>
      <button onclick="location.href='profile.html'" class="nav-btn-profile">
        <span class="desktop-text">ðŸ‘¤ Profile</span>
        <span class="mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>
      </button>


      
    </div>
  </nav>

  <!-- Mobile Date Range (Sticky below navbar) -->
  <div id="mobileDateRange" class="mobile-date-range glass-card"></div>

  <!-- Main Dashboard -->
  <main class="container">

    <!-- Balance Card -->
    <section class="balance-card glass-card animate-enter">
      <div class="liquid-bg liquid-green" id="fillBalance"></div>
      <div class="card-content">
        <h3>Remaining Balance</h3>
        <p id="balance">â‚¹0</p>
        <p class="hover-percentage" id="pctBalance">0%</p>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="actions animate-enter delay-1">
      <button onclick="openExpense()">âž• New Expense</button>
      <button onclick="openIncome()">âž• Monthly Budget</button>
    </section>

    <!-- Summary Cards -->
    <section class="summary">
      <div class="summary-card glass-card animate-enter delay-2">
        <div class="liquid-bg liquid-blue" id="fillIncome"></div>
        <div class="card-content">
          <h4>Total Income</h4>
          <p id="totalIncome">â‚¹0</p>
          <p class="hover-percentage" id="pctIncome">0%</p>
        </div>
      </div>
      <div class="summary-card glass-card animate-enter delay-3">
        <div class="liquid-bg liquid-red" id="fillExpense"></div>
        <div class="card-content">
          <h4>Total Expense</h4>
          <p id="totalExpense">â‚¹0</p>
          <p class="hover-percentage" id="pctExpense">0%</p>
        </div>
      </div>
    </section>

    <!-- Add Expense Modal -->
<div id="expenseModal" class="modal hidden">
  <div class="modal-content glass-card">
    <h3>Add Expense</h3>

    <input type="number" id="expenseAmount" placeholder="Amount (â‚¹)" />
    
    <select id="expenseCategory">
      <option value="">Select Category</option>
      <!-- Categories are populated dynamically from js/dashboard.js -->
    </select>

    <input type="date" id="expenseDate" style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); color-scheme: dark;" />

    <input type="text" id="expenseDesc" placeholder="Description (optional)" />

    <div class="modal-actions">
      <button onclick="addExpense()">Save</button>
      <button class="cancel" onclick="closeExpense()">Cancel</button>
    </div>
  </div>
</div>

<!-- Add Income Modal -->
<div id="incomeModal" class="modal hidden">
  <div class="modal-content glass-card">
    <h3>Add Income</h3>

    <input type="number" id="incomeAmount" placeholder="Amount (â‚¹)" />
    <input type="text" id="incomeSource" placeholder="Source (Salary, Freelance)" />
    <input type="date" id="incomeDate" style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); color-scheme: dark;" />

    <div class="modal-actions">
      <button onclick="addIncome()">Save</button>
      <button class="cancel" onclick="closeIncome()">Cancel</button>
    </div>
  </div>
</div>


<section class="filters glass-card animate-enter delay-4">
  <div class="filter-group">
    <label>Date Range:</label>
    <div class="date-inputs">
      <input type="date" id="startDate" placeholder="dd-mm-yyyy" style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); color-scheme: dark;">
      <input type="date" id="endDate" placeholder="dd-mm-yyyy" style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); color-scheme: dark;">
    </div>
  </div>
  <div class="filter-actions">
    <button onclick="filterCharts()" class="btn-filter">Filter</button>
    <button onclick="resetFilters()" class="btn-reset">Reset</button>
  </div>
</section>

<!-- ANALYTICS CAROUSEL -->
<section class="analytics-carousel glass-card animate-enter delay-5" style="margin-top: 30px;">
  <div class="carousel-container">
    <div class="carousel-track" id="analyticsTrack">
      
      <!-- Slide 1: Category Distribution -->
      <div class="carousel-slide">
        <h3>Spending by Category</h3>
        <div class="chart-wrapper">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>

      <!-- Slide 2: Weekly Trend -->
      <div class="carousel-slide">
        <h3>Last 7 Days Trend</h3>
        <div class="chart-wrapper">
          <canvas id="weeklyChart"></canvas>
        </div>
      </div>

      <!-- Slide 4: Yearly Overview (New) -->
      <div class="carousel-slide">
        <h3>Yearly Income vs Expense</h3>
        <div class="chart-wrapper">
          <canvas id="yearlyChart"></canvas>
        </div>
      </div>

      <!-- Slide 5: Day of Week Analysis (New) -->
      <div class="carousel-slide">
        <h3>Busiest Spending Days</h3>
        <div class="chart-wrapper">
          <canvas id="dayOfWeekChart"></canvas>
        </div>
      </div>

    </div>
  </div>
  <div class="carousel-dots" id="carouselDots"></div>
</section>

<!-- Monthly Expenses (Standalone) -->
<section class="glass-card animate-enter delay-6" style="margin-top: 30px; padding: 20px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h3 style="margin: 0;">Monthly Expenses</h3>
    <div style="display: flex; align-items: center; gap: 10px;">
      <span id="monthlyYearTotal" style="font-size: 0.9rem; font-weight: 600; color: #34d399;"></span>
      <select id="monthlyChartYear" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 6px; padding: 4px 8px; outline: none; cursor: pointer; font-size: 0.9rem;">
        <!-- Options populated by JS -->
      </select>
    </div>
  </div>
  <div class="chart-scroll-wrapper">
    <div id="monthlyChartContainer">
      <canvas id="monthlyChart"></canvas>
    </div>
  </div>
</section>



<!-- Expense List -->
<section class="expense-list glass-card animate-enter delay-7">
  <div class="expense-header">
    <h3>Recent Expenses <span class="mobile-swipe-hint">Swipe â†”</span></h3>
    <button onclick="location.href='yearly.html'">View All</button>
  </div>



  <div class="table-responsive">
    <table class="expense-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Amount</th>
          <th>Category</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody id="expenseTableBody">
        <tr><td colspan="4" style="text-align:center; padding: 20px;">Loading expenses...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="pagination-controls">
    <button id="prevPageBtn" class="pagination-btn" title="Previous"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
    <span id="pageInfo" style="font-weight: 600; color: rgba(255,255,255,0.8);"></span>
    <button id="nextPageBtn" class="pagination-btn" title="Next"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
  </div>
</section>



  </main>

  <button id="backToTopBtn" title="Back to Top">â†‘</button>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <script type="module" src="js/dashboard.js"></script>
  <script type="module">
    import { apiRequest } from './js/api.js';

    let allExpenses = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    function renderCurrentPage() {
        const tbody = document.getElementById("expenseTableBody");
        const pageInfo = document.getElementById("pageInfo");
        const prevBtn = document.getElementById("prevPageBtn");
        const nextBtn = document.getElementById("nextPageBtn");

        if (!tbody || !pageInfo || !prevBtn || !nextBtn) return;

        const totalPages = Math.ceil(allExpenses.length / itemsPerPage);
        
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageItems = allExpenses.slice(startIndex, endIndex);

        if (pageItems.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px;">No expenses found.</td></tr>`;
        } else {
            tbody.innerHTML = pageItems.map(tx => `
                <tr>
                  <td style="white-space: nowrap;">${new Date(tx.date).toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-')}</td>
                  <td style="font-weight: 600; color: #ef4444;">â‚¹${tx.amount}</td>
                  <td><span style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem;">${tx.category}</span></td>
                  <td>${tx.description || '-'}</td>
                </tr>
            `).join('');
        }

        pageInfo.innerText = `Page ${currentPage} of ${totalPages || 1}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;

        prevBtn.style.opacity = prevBtn.disabled ? 0.5 : 1;
        prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
        nextBtn.style.opacity = nextBtn.disabled ? 0.5 : 1;
        nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
    }

    function nextPage() {
        const totalPages = Math.ceil(allExpenses.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderCurrentPage();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderCurrentPage();
        }
    }

    // Fix: Ensure Recent Expenses are sorted by LIFO (Newest First) to match Profile
    async function loadRecentExpensesLIFO() {
      try {
        // Fetch all expenses to sort correctly
        const res = await apiRequest("/expenses", "GET", null, { skipLoader: true });
        allExpenses = (res.data || []).sort((a, b) => {
          return new Date(b.date) - new Date(a.date);
        }).slice(0, 20);

        currentPage = 1;
        renderCurrentPage();

      } catch (e) { console.error("Recent fix error", e); }
    }
    
    // Execute after a short delay to override dashboard.js
    setTimeout(loadRecentExpensesLIFO, 500);

    document.getElementById('prevPageBtn').addEventListener('click', prevPage);
    document.getElementById('nextPageBtn').addEventListener('click', nextPage);

    // Swipe Logic for Mobile Pagination
    const tableContainer = document.querySelector('.table-responsive');
    let touchStartX = 0;
    let touchEndX = 0;

    if (tableContainer) {
      tableContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
      tableContainer.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        if (touchStartX - touchEndX > 50) nextPage(); // Swipe Left -> Next
        if (touchEndX - touchStartX > 50) prevPage(); // Swipe Right -> Prev
      }, { passive: true });
    }
  </script>
</body>
</html>
